### Configuring Multihomed Nodes and Virtual Machines

## Summary

| Feature             | NMState Operator                                 | Multus CNI                                       |
|----------------------|-------------------------------------------------|---------------------------------------------------|
| **Manages** | Node network config (e.g., bridges, bonding, VLANs) | Pod/VM networking (multiple interfaces)         |
| **Applies to** | OpenShift nodes                                 | OpenShift pods and VMs                             |
| **Configurations** | Linux bridges, OVS bridges, NICs, bonding        | Attaching multiple interfaces to VMs/pods          |
| **Example usage** | Creating a Linux bridge (br1)                   | Attaching a VM to br1 for external access        |

- By combining NMState and Multus, OpenShift administrators can configure nodes, enable multihomed VMs, and ensure flexible networking across clusters.

---
NMState Operator Overview: The NMState operator is a tool in OpenShift that allows you to configure and manage network settings on OpenShift nodes declaratively. It helps in:
- Reporting node network states.
- Applying and validating network configurations.
- Configuring additional network interfaces (e.g., Linux bridges).
- You install the NMState operator from the OperatorHub and then create an NMState instance (nmstate) to deploy the controller on all nodes.

API Resources provided by NMState:
- NodeNetworkState (NNS): Shows the current network configuration of a node.
- NodeNetworkConfigurationPolicy (NNCP): Defines intended network configurations for nodes.
- NodeNetworkConfigurationEnactment (NNCE): Monitors the application of NNCP and rolls back changes if needed.
  
Configuring Node Network State (NNS):
- Each OpenShift node has an NNS resource, which reflects its current network state `oc get nns <node-name> -o yaml`
- You can also check Networking → NodeNetworkState in the OpenShift web console.

Configuring Node Network Configuration Policy (NNCP):
- NNCP defines how the node network should be configured. For example, to configure a Linux bridge (br1) on a worker node
```yaml
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: br1-policy
spec:
  nodeSelector:
    node-role.kubernetes.io/worker: ""   # Apply to worker nodes
  desiredState:
    interfaces:
      - name: br1
        type: linux-bridge
        state: up
        ipv4:
          dhcp: true
          enabled: true
        bridge:
          options:
            stp:
              enabled: false
          port:
            - name: ens4   # Attach ens4 to the bridge
```
- To apply: `oc apply -f br1-policy.yaml`
- To check status: `oc get nncp` `oc get nncp br1-policy -o yaml`
- Removing a bridge or bonding interface makes the attached NIC go down. Ensure a NIC is configured separately to maintain connectivity.

Node Network Configuration Enactment (NNCE):
- After applying an NNCP, an NNCE resource is created for each node affected by the policy. This tracks success or failure. `oc get nnce` `oc get nnce <nnce-name> -o yaml`
- If a failure occurs, NMState rolls back to the previous configuration and logs errors.

Connecting Virtual Machines to Multiple Networks:
- By default, VMs use the default pod network. If a VM needs access to an external network, it requires a Linux bridge (or OVS bridge) and Multus CNI.
- Configuring a Linux Bridge. Create an NNCP (as shown earlier) to configure a bridge. Create a Network Attachment Definition (NAD) to allow VMs to connect:
```yaml
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: br1-bridge-network
spec:
  config: '{
    "cniVersion": "0.3.1",
    "type": "cnv-bridge",
    "bridge": "br1",
    "vlan": 0,
    "macspoofchk": true
  }'
```
- Apply it: `oc apply -f nad.yaml`
- Attach the NAD to a VM: Go to Virtualization → Virtual Machines. Click Network Interfaces → Add Network Interface. Choose the NAD (br1-bridge-network). Click Add.

Hot Plugging Secondary Network Interfaces:
- OpenShift Virtualization allows hot plugging (adding/removing network interfaces on a running VM).
- Using the Web Console: Navigate to Virtualization → Virtual Machines. Select the VM and go to Configuration → Network Interfaces. Click Add Network Interface, select the NAD, and attach.
- Using the CLI : Edit the VM spec to add the secondary NIC: `oc edit vm vm-fedora` then, live migrate the VM to attach the new interface: `virtctl migrate vm vm-fedora`
```yaml
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: vm-fedora
spec:
  template:
    spec:
      domain:
        devices:
          interfaces:
            - name: defaultnetwork
              masquerade: {}
            - name: secondary_nic
              bridge: {}
      networks:
        - name: defaultnetwork
          pod: {}
        - name: secondary_nic
          multus:
            networkName: br1-bridge-network
```

- 
