### Configuring External Access to Virtual Machines
---
Summary:
- Create a Service for the VM.
- Create a Route or Ingress for external access.
- If using network policies, allow traffic from openshift-ingress.
- For TLS security, configure routes with proper TLS termination.
---

Service Types for External Access:
- NodePort: Opens a port on each node in the cluster, forwarding traffic to the targeted service. This requires direct node access and is less secure.
- LoadBalancer: Automatically provisions an external load balancer (in cloud environments) to route traffic to the application. In bare-metal environments, MetalLB or External IPs can be used.
- Ingress Controller: Manages HTTP(S) traffic using routes. It’s the primary way to expose applications externally in OpenShift.

OpenShift Routes:
- Routes map external traffic to internal services.
- The OpenShift router (based on HAProxy) handles incoming traffic and forwards it based on defined routes.
- Format: routename-namespace.default_domain `intranet-prod.mycompany.com`
- Command-line: `oc expose service/web`
- Custom DNS: `oc expose service/web --hostname web-production.apps.mycompany.com`
- Web Console: Navigate to Networking → Routes, select namespace, and define the route.

Path-Based Routing:
- Allows different services to be accessible under the same domain using paths.
```bash
oc expose service/static --path=/static --hostname=intranet-prod.apps.mycompany.com
oc expose service/restapi --path=/api --hostname=intranet-prod.apps.mycompany.com
```
- /static → static web content
- /api → backend service

Encrypted Routes (TLS/HTTPS):
- Three types of TLS termination:
- Edge: TLS is terminated at the router (traffic inside the cluster is unencrypted).
- Passthrough: TLS is handled by the application (router forwards encrypted traffic).
- Re-encryption: TLS is terminated at the router, then re-encrypted before forwarding.

Creating Encrypted Routes:
- Web Console: Under Create Route, set TLS options.
- CLI: `oc create route edge --service web --hostname api.apps.acme.com` Add --cert, --key, and --ca-cert options for custom certificates.

Configuring Routes for VMs:
- Since VMs run as pods (virt-launcher pods), they need a Service before exposing them via a route.
- Create a Service for the VM
```yaml
apiVersion: v1
kind: Service
metadata:
  name: web
  namespace: prod2
spec:
  type: ClusterIP
  selector:
    tier: front
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
```
- Expose the VM service as a route: `oc expose service/web`

Network Policy Considerations:
- If network policies are enabled, router pods (running in openshift-ingress namespace) need to be explicitly allowed.
- Example policy:
```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: allow-from-openshift-ingress
spec:
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          network.openshift.io/policy-group: ingress
  podSelector: {}
```

Kubernetes Ingress vs OpenShift Routes:
- Ingress is the standard Kubernetes method for external access, while Routes are OpenShift-specific with additional features like TLS re-encryption.
- Example Ingress definition:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web
spec:
  rules:
    - host: web-production.apps.mycompany.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: web
                port:
                  number: 8080
```
---
### Exercise

- The process of exposing a virtual machine (VM) running inside an OpenShift cluster to external traffic while ensuring network security
