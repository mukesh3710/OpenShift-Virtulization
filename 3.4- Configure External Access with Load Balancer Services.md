### Configure External Access with Load Balancer Services

---
Summary:
- MetalLB provides LoadBalancer capabilities on bare metal.
- Use NodePort for quick testing but prefer LoadBalancer for stable access.
- MetalLB assigns external IPs via ARP (Layer 2) or BGP (Layer 3).
- VM access requires a virt-launcher pod label for service exposure.
- Use oc expose to generate service configurations.

---

Why Use a Load Balancer?:
- In Kubernetes/OpenShift, services typically expose applications internally using ClusterIP. However, when you need external access, you have two main options:
- NodePort: Opens a specific port (30000-32767) on each cluster node.
- LoadBalancer: Assigns a fixed external IP to route traffic, useful for non-HTTP services like SSH, MySQL, LDAP, SMTP.

NodePort vs. LoadBalancer:
- For on-prem environments, MetalLB enables LoadBalancer functionality by providing an IP from a pre-defined pool.
| Feature           | NodePort                      | LoadBalancer                  |
|-------------------|-------------------------------|-------------------------------|
| **External Access** | Requires node IP exposure    | Provides a fixed external IP  |
| **Security** | Risky (exposes node IPs)     | More secure, no need to expose nodes |
| **Port Range** | 30000-32767                   | Any valid port                |
| **Cloud Provider Support** | Works anywhere              | Requires cloud provider or MetalLB |

Configuring External Access Using MetalLB:
- Install MetalLB Operator:
- Install MetalLB Operator via OpenShift OperatorHub. `oc get metallb -n metallb-system`
- Configure IPAddressPool to define available external IPs. `oc get ipaddresspool -n metallb-system`
- Enable L2Advertisement (for Layer 2 ARP-based traffic). `oc get ipaddresspool -n metallb-system`
- Create a LoadBalancer Service for a VM
- Find the virt-launcher pod associated with the VM: `oc get pod -l kubevirt.io/domain=vm1 -o name`
- Create a YAML definition for the LoadBalancer service
```yaml
apiVersion: v1
kind: Service
metadata:
  name: vm1
spec:
  type: LoadBalancer
  selector:
    kubevirt.io/domain: vm1
  ports:
    - protocol: TCP
      port: 22
      targetPort: 22
```
- Apply the configuration: `oc apply -f service.yaml`
- Verify that the service is running with an assigned external IP: `oc get services` `oc get endpoints`
- Test external access: `nc -vz <external-ip> 22`
